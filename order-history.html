<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Order History</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
</head>
<body>
  <div class="container">
    <h2>📜 My Order History</h2>
    <input type="text" id="searchBox" placeholder="Search by Order ID / Client ID">
    <select id="statusFilter">
      <option value="ALL">All Status</option>
      <option value="PENDING">Pending</option>
      <option value="COMPLETED">Completed</option>
      <option value="CANCELLED">Cancelled</option>
    </select>

    <table id="ordersTable">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Client ID</th>
          <th>💎 Amount</th>
          <th>Date & Time</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="ordersBody"></tbody>
    </table>
  </div>

<script>
  // 🔥 Firebase Config (একই config এখানে বসাবেন)
  const firebaseConfig = {
    apiKey: "YOUR_KEY",
    authDomain: "YOUR_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_MSG_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let orders = [];

  auth.onAuthStateChanged(user => {
    if (user) {
      db.collection("orders")
        .where("userId", "==", user.uid)
        .orderBy("timestamp", "desc")
        .onSnapshot(snapshot => {
          orders = [];
          snapshot.forEach(doc => {
            let data = doc.data();
            let orderTime = data.timestamp?.toDate ? data.timestamp.toDate() : null;

            // Auto Cancel after 5 min
            if (orderTime && data.status === "PENDING") {
              const now = new Date();
              const diff = (now - orderTime) / 1000 / 60;
              if (diff >= 5) {
                db.collection("orders").doc(doc.id).update({ status: "CANCELLED" });
                data.status = "CANCELLED";
              }
            }

            orders.push({
              id: doc.id,
              clientId: data.clientId || "-",
              amount: data.amount || 0,
              status: data.status || "Unknown",
              timestamp: orderTime
            });
          });
          renderOrders();
        });
    } else {
      document.getElementById("ordersBody").innerHTML =
        `<tr><td colspan="5">⚠ Please login to see orders</td></tr>`;
    }
  });

  function renderOrders() {
    const search = document.getElementById("searchBox").value.toLowerCase();
    const filter = document.getElementById("statusFilter").value;
    const tbody = document.getElementById("ordersBody");
    tbody.innerHTML = "";

    orders
      .filter(o =>
        (o.id.toLowerCase().includes(search) || o.clientId.toLowerCase().includes(search)) &&
        (filter === "ALL" || o.status === filter)
      )
      .forEach(o => {
        let row = `
          <tr>
            <td>${o.id}</td>
            <td>${o.clientId}</td>
            <td>💎 ${o.amount}</td>
            <td>${o.timestamp ? o.timestamp.toLocaleString() : "-"}</td>
            <td>${o.status}</td>
          </tr>`;
        tbody.innerHTML += row;
      });
  }

  document.getElementById("searchBox").addEventListener("input", renderOrders);
  document.getElementById("statusFilter").addEventListener("change", renderOrders);
</script>
</body>
</html>