<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order History</title>
  <style>
    :root{
      --bg:#0f1115;--card:#171a21;--text:#e7eaf0;--muted:#9aa3b2;
      --accent:#06b6d4;--ok:#10b981;--bad:#ef4444;
    }
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    header{background:var(--card);border-bottom:1px solid #202635;padding:10px}
    .top-row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .site-info{display:flex;align-items:center;gap:10px}
    .site-logo{height:40px;border-radius:8px}
    .site-name{font-size:20px;font-weight:800;color:var(--accent)}
    .user-info{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .user-avatar{width:40px;height:40px;border-radius:50%;background:#2b3347;object-fit:cover}
    .user-box{background:#1f2430;padding:6px 12px;border-radius:8px;font-size:14px;font-weight:600;display:flex;align-items:center;gap:6px}
    .balance{color:var(--ok);font-weight:700}
    .btn{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600}
    .btn.logout{background:var(--bad);color:#fff}
    .btn.login{background:var(--accent);color:#001}
    .nav-row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .nav-row a{background:#1f2430;padding:8px 14px;border-radius:8px;text-decoration:none;color:var(--text);font-weight:600;transition:.2s}
    .nav-row a:hover{background:var(--accent);color:#001}

    main{padding:16px}
    .search-box{display:flex;justify-content:center;margin:10px 0 14px}
    .search-box input{width:95%;max-width:520px;padding:10px 12px;border-radius:8px;border:1px solid #333;background:#171a21;color:var(--text)}
    table{width:95%;margin:auto;border-collapse:collapse;background:#171a21;font-size:14px}
    th,td{border:1px solid #2b3340;padding:8px;text-align:center}
    th{background:var(--accent);color:#001}
    .status-box{display:inline-block;width:28px;height:28px;line-height:28px;border-radius:6px;color:#fff;font-size:16px}
    .waiting{background:#eab308}
    .completed{background:#22c55e}
    .cancelled{background:#ef4444}
    .pagination{display:flex;gap:10px;justify-content:center;margin:16px 0}
    .pagination button{background:var(--accent);border:none;color:#001;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:700}
    .pagination button:disabled{background:#333;color:#777;cursor:not-allowed}
    .empty{width:95%;margin:12px auto;text-align:center;color:var(--muted)}
    @media (max-width:600px){
      .top-row{flex-direction:column;align-items:flex-start}
      .user-info{width:100%;justify-content:space-between}
      .nav-row{justify-content:center}
      th,td{padding:6px;font-size:13px}
    }
  </style>
</head>
<body>

  <!-- ===== Header (as provided) ===== -->
  <header>
    <div class="top-row">
      <div class="site-info">
        <img src="https://sarkar-telecom.github.io/Topup/logo.png" alt="Logo" class="site-logo">
        <span class="site-name">SARKAR TELECOM</span>
      </div>
      <div class="user-info" id="userInfo"></div>
    </div>
    <div class="nav-row">
      <a href="dashboard.html">Dashboard</a>
      <a href="order.html">Order</a>
      <a href="order-history.html">Order History</a>
      <a href="profile.html">Profile</a>
    </div>
  </header>

  <main>
    <div class="search-box">
      <input id="searchInput" type="text" placeholder="üîç Search by Profile ID / Amount / Status">
    </div>

    <table>
      <thead>
        <tr>
          <th>SL</th>
          <th>Profile ID</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody id="orderTable"></tbody>
    </table>

    <div class="empty" id="emptyBox" style="display:none;">No orders found.</div>

    <div class="pagination">
      <button id="prevBtn">‚¨Ö Prev</button>
      <button id="nextBtn">Next ‚û°</button>
    </div>
  </main>

  <!-- ===== Firebase (Header logic) ===== -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBIIOv-2Laqugv5_HAIRNJllp8YUfYndF8",
      authDomain: "diamond-recharge-f7f59.firebaseapp.com",
      projectId: "diamond-recharge-f7f59",
      storageBucket: "diamond-recharge-f7f59.appspot.com",
      messagingSenderId: "657717928489",
      appId: "1:657717928489:web:70431ebc9afb7002d4b238",
      measurementId: "G-TDK78BQ8SQ"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userInfo = document.getElementById("userInfo");
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        let balance = 0, avatarUrl = user.photoURL || "https://via.placeholder.com/40";
        try {
          const snap = await getDoc(doc(db, "users", user.uid));
          if (snap.exists()) {
            const data = snap.data();
            balance = data.balance || 0;
            if (data.avatar) avatarUrl = data.avatar;
          }
        } catch {}
        userInfo.innerHTML = `
          <img src="${avatarUrl}" class="user-avatar" alt="User">
          <div class="user-box">${user.email}</div>
          <div class="user-box balance">üíé ${balance}</div>
          <button class="btn logout" id="logoutBtn">Logout</button>
        `;
        document.getElementById("logoutBtn").addEventListener("click", async () => {
          await signOut(auth); window.location.href = "login.html";
        });
      } else {
        userInfo.innerHTML = `<button class="btn login" onclick="window.location.href='login.html'">Login</button>`;
      }
    });
  </script>

  <!-- ===== Orders (Only current user's orders) ===== -->
  <script type="module">
    import { getApps, getApp, initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBIIOv-2Laqugv5_HAIRNJllp8YUfYndF8",
      authDomain: "diamond-recharge-f7f59.firebaseapp.com",
      projectId: "diamond-recharge-f7f59",
      storageBucket: "diamond-recharge-f7f59.appspot.com",
      messagingSenderId: "657717928489",
      appId: "1:657717928489:web:70431ebc9afb7002d4b238",
      measurementId: "G-TDK78BQ8SQ"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const orderTable = document.getElementById("orderTable");
    const emptyBox   = document.getElementById("emptyBox");
    const prevBtn    = document.getElementById("prevBtn");
    const nextBtn    = document.getElementById("nextBtn");
    const searchInput= document.getElementById("searchInput");

    let orders = [];
    let filtered = [];
    let currentPage = 1;
    const rowsPerPage = 10;

    function formatTime(ts){
      if (!ts) return "-";
      try{
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      }catch{ return "-"; }
    }

    function render(){
      orderTable.innerHTML = "";
      const list = filtered.length ? filtered : orders;
      emptyBox.style.display = list.length ? "none" : "block";

      const start = (currentPage-1)*rowsPerPage;
      const end   = start + rowsPerPage;
      const page  = list.slice(start, end);

      page.forEach((o, idx) => {
        let cls="waiting", sym="‚è≥";
        if (o.status==="COMPLETED"){ cls="completed"; sym="‚úÖ"; }
        else if (o.status==="CANCELLED"){ cls="cancelled"; sym="üö´"; }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${list.length - (start + idx)}</td>
          <td>${o.profileId || "-"}</td>
          <td>${o.amount ?? "-"}</td>
          <td><span class="status-box ${cls}">${sym}</span></td>
          <td>${formatTime(o.createdAt)}</td>
        `;
        orderTable.appendChild(tr);
      });

      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = end >= list.length;
    }

    function applySearch(){
      const t = searchInput.value.trim().toLowerCase();
      if (!t){ filtered = []; currentPage=1; render(); return; }
      filtered = orders.filter(o =>
        (o.profileId && String(o.profileId).toLowerCase().includes(t)) ||
        (o.amount !== undefined && String(o.amount).toLowerCase().includes(t)) ||
        (o.status && String(o.status).toLowerCase().includes(t))
      );
      currentPage = 1;
      render();
    }

    prevBtn.onclick = () => { if (currentPage>1){ currentPage--; render(); } };
    nextBtn.onclick = () => {
      const list = filtered.length ? filtered : orders;
      if (currentPage*rowsPerPage < list.length){ currentPage++; render(); }
    };
    searchInput.addEventListener("input", applySearch);

    async function loadMyOrders(uid){
      // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶®‡ßá‡¶¨‡ßã: where("userId","==", uid)
      const q = query(collection(db, "orders"), where("userId","==", uid));
      const snap = await getDocs(q);
      orders = snap.docs.map(d => ({ id:d.id, ...d.data() }))
                       .sort((a,b) => {
                         const ta = a.createdAt?.toMillis?.() ?? (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                         const tb = b.createdAt?.toMillis?.() ?? (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                         return tb - ta; // newest first
                       });
      filtered = [];
      currentPage = 1;
      render();
    }

    onAuthStateChanged(auth, (user) => {
      if (!user){
        orders = []; filtered = []; render();
        emptyBox.style.display = "block";
        emptyBox.textContent = "Please login to view your orders.";
        return;
      }
      emptyBox.textContent = "No orders found.";
      loadMyOrders(user.uid).catch(err=>{
        emptyBox.style.display="block";
        emptyBox.textContent = "Error loading orders: " + err.message;
      });
    });
  </script>
</body>
</html>