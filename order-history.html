<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Order History</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    body { background: #121212; color: #fff; font-family: Arial, sans-serif; }
    .container { width: 95%; max-width: 900px; margin: auto; padding: 20px; }
    h2 { text-align: center; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; text-align: center; border: 1px solid #333; }
    th { background: #1f1f1f; }
    .status-box { padding: 5px 10px; border-radius: 6px; color: #fff; font-weight: bold; }
    .waiting { background: orange; }
    .confirmed { background: green; }
    .cancelled { background: red; }
    .filter { margin-bottom: 15px; display: flex; justify-content: center; gap: 10px; }
    select, input { padding: 6px; border-radius: 6px; border: none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>My Order History</h2>

    <div class="filter">
      <input type="text" id="searchInput" placeholder="Search by Order ID...">
      <select id="statusFilter">
        <option value="">All Status</option>
        <option value="WAITING">WAITING</option>
        <option value="CONFIRMED">CONFIRMED</option>
        <option value="CANCELLED">CANCELLED</option>
      </select>
    </div>

    <table>
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Profile ID</th>
          <th>Amount</th>
          <th>Date & Time</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="orderTableBody">
        <tr><td colspan="5">Loading orders...</td></tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    // âœ… Firebase Config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, limit, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const tableBody = document.getElementById("orderTableBody");
    const searchInput = document.getElementById("searchInput");
    const statusFilter = document.getElementById("statusFilter");

    // Auto Cancel Function
    async function autoCancelOrder(orderId, createdAt, status) {
      const fiveMin = 5 * 60 * 1000;
      if (status === "WAITING" && (Date.now() - createdAt.toMillis()) > fiveMin) {
        await updateDoc(doc(db, "orders", orderId), { status: "CANCELLED" });
      }
    }

    // Listen user auth
    onAuthStateChanged(auth, user => {
      if (user) {
        loadOrders(user.uid);
      } else {
        tableBody.innerHTML = `<tr><td colspan="5">âš  Please login to see your orders</td></tr>`;
      }
    });

    function loadOrders(uid) {
      const q = query(
        collection(db, "orders"),
        where("userId", "==", uid),
        orderBy("createdAt", "desc"),
        limit(20)
      );

      onSnapshot(q, snapshot => {
        if (snapshot.empty) {
          tableBody.innerHTML = `<tr><td colspan="5">No orders found</td></tr>`;
          return;
        }

        let rows = "";
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          autoCancelOrder(docSnap.id, data.createdAt, data.status);

          let statusClass =
            data.status === "WAITING" ? "waiting" :
            data.status === "CONFIRMED" ? "confirmed" : "cancelled";

          rows += `
            <tr data-status="${data.status}" data-id="${docSnap.id}">
              <td>${docSnap.id}</td>
              <td>${data.profileId}</td>
              <td>ðŸ’Ž ${data.amount}</td>
              <td>${data.createdAt.toDate().toLocaleString()}</td>
              <td><span class="status-box ${statusClass}">${data.status}</span></td>
            </tr>
          `;
        });
        tableBody.innerHTML = rows;
      });
    }

    // Filter Orders
    function filterOrders() {
      const term = searchInput.value.toLowerCase();
      const status = statusFilter.value;
      Array.from(tableBody.getElementsByTagName("tr")).forEach(row => {
        const id = row.dataset.id.toLowerCase();
        const st = row.dataset.status;
        row.style.display =
          (id.includes(term) && (status === "" || st === status)) ? "" : "none";
      });
    }
    searchInput.addEventListener("input", filterOrders);
    statusFilter.addEventListener("change", filterOrders);
  </script>
</body>
</html>