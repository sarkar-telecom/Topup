<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>Diamond Recharge ‚Äî Login / Register</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* === Theme (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã) === */
    :root { --bg:#0f1115; --card:#171a21; --text:#e7eaf0; --muted:#9aa3b2; --accent:#06b6d4; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui}
    a{color:var(--accent);cursor:pointer}
    .center{min-height:100vh;display:grid;place-items:center;padding:16px}
    .card{background:var(--card);border:1px solid #202635;padding:24px;border-radius:16px;box-shadow:0 6px 16px rgba(0,0,0,.35);width:100%;max-width:420px}
    h2{margin:0 0 12px}
    p.muted{color:var(--muted);margin:8px 0 16px}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid #202635;background:#0c111a;color:var(--text);margin:8px 0}
    button{width:100%;padding:12px;border:none;border-radius:12px;background:var(--accent);color:#001;font-weight:700;cursor:pointer;margin-top:8px}
    .row{display:flex;gap:8px;align-items:center;justify-content:center}
    .switch{margin-top:12px;text-align:center}
    .hidden{display:none}

    /* Alerts / inline validation */
    .alert{border-radius:12px;padding:10px 12px;margin:10px 0;font-weight:600}
    .alert.warn{background:#2a2010;border:1px solid var(--warn);color:#ffdca3}
    .alert.bad{background:#2a1416;border:1px solid var(--bad);color:#ffc7cc}
    .alert.ok{background:#0f261f;border:1px solid var(--ok);color:#b8f3d7}

    .help{font-size:12px;color:#d3b7b7;margin-top:-6px;margin-bottom:6px}
    .flex-between{display:flex;align-items:center;justify-content:space-between}
  </style>
</head>
<body>
  <div class="center">
    <!-- Login Card -->
    <div id="loginBox" class="card">
      <h2>‡¶≤‡¶ó‡¶á‡¶®</h2>
      <p class="muted">‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶ì ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®</p>

      <div id="loginAlert" class="alert hidden"></div>

      <form id="loginForm" novalidate>
        <input id="loginEmail" type="email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤" autocomplete="email" required />
        <div id="loginEmailHelp" class="help"></div>

        <input id="loginPassword" type="password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° (‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)" autocomplete="current-password" required minlength="6" />
        <div id="loginPassHelp" class="help"></div>

        <button type="submit">‡¶≤‡¶ó‡¶á‡¶®</button>
      </form>

      <div class="switch">
        ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞? <a id="toSignup">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</a>
      </div>
    </div>

    <!-- Signup Card -->
    <div id="signupBox" class="card hidden">
      <h2>‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞</h2>
      <p class="muted">‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</p>

      <div id="signupAlert" class="alert hidden"></div>

      <form id="signupForm" novalidate>
        <input id="signupName" type="text" placeholder="‡¶™‡ßÅ‡¶∞‡ßã ‡¶®‡¶æ‡¶Æ" autocomplete="name" required />
        <div id="signupNameHelp" class="help"></div>

        <input id="signupEmail" type="email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤" autocomplete="email" required />
        <div id="signupEmailHelp" class="help"></div>

        <input id="signupPassword" type="password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° (‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)" autocomplete="new-password" required minlength="6" />
        <div id="signupPassHelp" class="help"></div>

        <button type="submit">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </form>

      <div class="switch">
        ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? <a id="toLogin">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</a>
      </div>
    </div>
  </div>

  <!-- Firebase & App Logic -->
  <script type="module">
    /* =========================
       Firebase Imports & Init
    ==========================*/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getAuth, setPersistence, browserLocalPersistence,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      updateProfile, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      serverTimestamp, addDoc, collection
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó (storageBucket ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá)
    const firebaseConfig = {
      apiKey: "AIzaSyDJRm9-jRkxVrTLYBzK1gGrRmAEu29jVrU",
      authDomain: "diamond-recharge-f7f59.firebaseapp.com",
      projectId: "diamond-recharge-f7f59",
      storageBucket: "diamond-recharge-f7f59.appspot.com",
      messagingSenderId: "657717928489",
      appId: "1:657717928489:web:70431ebc9afb7002d4b238",
      measurementId: "G-TDK78BQ8SQ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // üîí Refresh/reload ‡¶è‡¶∞ ‡¶™‡¶∞‡ßá‡¶ì ‡¶≤‡¶ó‡¶ø‡¶® ‡¶•‡¶æ‡¶ï‡¶æ‡¶§‡ßá local persistence
    await setPersistence(auth, browserLocalPersistence);

    /* =========================
       UI Helpers
    ==========================*/
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove("hidden");
    const hide = (el) => el.classList.add("hidden");

    const showAlert = (box, type, msg) => {
      box.className = "alert " + (type||"");
      box.textContent = msg;
      show(box);
    };
    const clearAlert = (box) => {
      box.className = "alert hidden";
      box.textContent = "";
      hide(box);
    };
    const setHelp = (el, msg) => { el.textContent = msg || ""; };

    const isValidEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

    // Card toggles
    const loginBox = $("loginBox");
    const signupBox = $("signupBox");
    $("toSignup").onclick = () => { hide(loginBox); show(signupBox); };
    $("toLogin").onclick  = () => { hide(signupBox); show(loginBox); };

    /* =========================
       Firestore Helpers
    ==========================*/
    async function ensureUserDoc(user) {
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, {
          uid: user.uid,
          name: user.displayName || "",
          email: user.email,
          balance: 0,
          status: "active",
          createdAt: serverTimestamp()
        });
      } else {
        // ‡¶®‡¶æ‡¶Æ ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        const data = snap.data() || {};
        if (!data.name && user.displayName) {
          await updateDoc(ref, { name: user.displayName });
        }
      }
    }

    async function logAuthEvent(type, payload = {}) {
      try {
        await addDoc(collection(db, "authLogs"), {
          type,                 // "login" | "signup"
          at: serverTimestamp(),
          ...payload
        });
      } catch {}
    }

    // Local storage utility (‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶≤‡¶æ‡¶á‡¶ü‡¶ì‡ßü‡ßá‡¶ü ‡¶°‡ßá‡¶ü‡¶æ)
    function saveSessionUser(user) {
      const obj = user ? {
        uid: user.uid, email: user.email, name: user.displayName || ""
      } : null;
      localStorage.setItem("sessionUser", JSON.stringify(obj));
    }

    /* =========================
       LOGIN
    ==========================*/
    $("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      clearAlert($("loginAlert"));
      setHelp($("loginEmailHelp"), "");
      setHelp($("loginPassHelp"), "");

      const email = $("loginEmail").value.trim();
      const pass  = $("loginPassword").value;

      // Client-side validation
      let bad = false;
      if (!isValidEmail(email)) {
        setHelp($("loginEmailHelp"), "‡¶∏‡¶†‡¶ø‡¶ï ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®");
        bad = true;
      }
      if (!pass || pass.length < 6) {
        setHelp($("loginPassHelp"), "‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá");
        bad = true;
      }
      if (bad) {
        showAlert($("loginAlert"), "warn", "‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        return;
      }

      try {
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        await ensureUserDoc(cred.user);
        saveSessionUser(cred.user);
        await logAuthEvent("login", { uid: cred.user.uid, email });
        showAlert($("loginAlert"), "ok", "‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶Ø‡¶æ‡¶ì‡ßü‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶ö‡¶æ‡¶á‡¶≤‡ßá:
        // location.href = "index.html";
      } catch (err) {
        // Firebase error mapping (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡ßü)
        let msg = "‡¶≤‡¶ó‡¶á‡¶® ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
        if (err.code === "auth/invalid-email")         msg = "‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§";
        if (err.code === "auth/user-not-found")        msg = "‡¶è‡¶á ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§";
        if (err.code === "auth/wrong-password")        msg = "‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡•§";
        if (err.code === "auth/too-many-requests")     msg = "‡¶Ö‡¶®‡ßá‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá, ‡¶ï‡¶ø‡¶õ‡ßÅ‡¶ï‡ßç‡¶∑‡¶£ ‡¶™‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
        if (err.code === "auth/network-request-failed")msg = "‡¶®‡ßá‡¶ü‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
        showAlert($("loginAlert"), "bad", msg);
      }
    });

    /* =========================
       SIGNUP (Register)
    ==========================*/
    $("signupForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      clearAlert($("signupAlert"));
      setHelp($("signupNameHelp"), "");
      setHelp($("signupEmailHelp"), "");
      setHelp($("signupPassHelp"), "");

      const name  = $("signupName").value.trim();
      const email = $("signupEmail").value.trim();
      const pass  = $("signupPassword").value;

      // Client-side validation
      let bad = false;
      if (!name || name.length < 2) {
        setHelp($("signupNameHelp"), "‡¶®‡¶æ‡¶Æ ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß® ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞ ‡¶¶‡¶ø‡¶®");
        bad = true;
      }
      if (!isValidEmail(email)) {
        setHelp($("signupEmailHelp"), "‡¶∏‡¶†‡¶ø‡¶ï ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®");
        bad = true;
      }
      if (!pass || pass.length < 6) {
        setHelp($("signupPassHelp"), "‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá");
        bad = true;
      }
      if (bad) {
        showAlert($("signupAlert"), "warn", "‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        return;
      }

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        if (name) { await updateProfile(cred.user, { displayName: name }); }
        await ensureUserDoc(cred.user);
        saveSessionUser(cred.user);
        await logAuthEvent("signup", { uid: cred.user.uid, email });
        showAlert($("signupAlert"), "ok", "‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶≤‡¶ó‡¶á‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡ßü ‡¶Ü‡¶õ‡ßá‡¶®‡•§");
        // location.href = "index.html";
      } catch (err) {
        let msg = "‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
        if (err.code === "auth/email-already-in-use")  msg = "‡¶è‡¶á ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá‡¶á ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá‡•§";
        if (err.code === "auth/invalid-email")         msg = "‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§";
        if (err.code === "auth/weak-password")         msg = "‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶Ü‡¶∞‡¶ì ‡¶∂‡¶ï‡ßç‡¶§‡¶ø‡¶∂‡¶æ‡¶≤‡ßÄ ‡¶¶‡¶ø‡¶® (‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)‡•§";
        if (err.code === "auth/network-request-failed")msg = "‡¶®‡ßá‡¶ü‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
        showAlert($("signupAlert"), "bad", msg);
      }
    });

    /* =========================
       Live Auth State (‡¶∞‡¶ø‡ßü‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ)
    ==========================*/
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // ‡¶≤‡¶ó‡¶° ‡¶á‡¶®: localStorage ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        saveSessionUser(user);

        // ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®
        // location.href = "index.html";
      } else {
        // ‡¶≤‡¶ó‡¶° ‡¶Ü‡¶â‡¶ü: ‡¶∏‡ßá‡¶∂‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞
        saveSessionUser(null);
      }
    });
  </script>
</body>
</html>