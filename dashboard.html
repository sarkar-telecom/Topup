<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - Sarkar Telecom</title>
  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#0f1115;color:#e7eaf0}
    main{padding:22px;max-width:900px;margin:0 auto}
    .card{background:#171a21;padding:28px;border-radius:14px;box-shadow:0 8px 26px rgba(0,0,0,.4);text-align:center;margin-top:26px}
    .btn-logout{background:#ef4444;border:none;padding:10px 18px;border-radius:8px;color:#fff;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <!-- header will be injected here -->
  <div id="header-container"></div>

  <main>
    <div class="card">
      <h1>Welcome, <span id="name">Loading...</span></h1>
      <p><strong>Email:</strong> <span id="email">â€”</span></p>
      <p><strong>Balance:</strong> ðŸ’Ž <span id="balance">0</span></p>
      <div style="margin-top:16px;">
        <button class="btn-logout" id="logout-btn">Logout</button>
      </div>
    </div>
  </main>

  <script>
    (async () => {
      // 1) load header fragment
      try {
        const res = await fetch('header.html');
        if (!res.ok) throw new Error('header fetch failed');
        const html = await res.text();
        document.getElementById('header-container').innerHTML = html;
      } catch (e) {
        console.error('Failed to load header.html', e);
        document.getElementById('header-container').innerHTML = '<!-- header load failed -->';
      }

      // 2) import header script (initializes firebase + onAuthStateChanged)
      let module = null;
      try {
        module = await import('./header-script.js');
      } catch (e) {
        console.error('Failed to import header-script.js', e);
      }

      // 3) populate dashboard fields:
      // prefer live data from module.getCurrentUserData(), fallback to localStorage snapshot
      async function populate() {
        // try module first
        if (module && module.getCurrentUserData) {
          try {
            const d = await module.getCurrentUserData();
            if (d && d.authUser) {
              const docData = d.userDoc || {};
              document.getElementById('name').textContent = (docData.name || d.authUser.displayName || 'User');
              document.getElementById('email').textContent = (docData.email || d.authUser.email || 'â€”');
              document.getElementById('balance').textContent = (docData.balance ?? 0);
              return;
            }
          } catch (err) {
            console.warn('getCurrentUserData failed', err);
          }
        }

        // fallback to localStorage snapshot
        try {
          const raw = localStorage.getItem('user');
          if (raw) {
            const s = JSON.parse(raw);
            document.getElementById('name').textContent = s.name || 'User';
            document.getElementById('email').textContent = s.email || 'â€”';
            document.getElementById('balance').textContent = (s.balance ?? 0);
            return;
          }
        } catch(e){}
        // if nothing, redirect to login
        // (we wait a little because auth state initialization could be async)
        setTimeout(()=> {
          const name = document.getElementById('name').textContent;
          if (name === 'Loading...' || name === '') {
            window.location.href = 'login.html';
          }
        }, 1200);
      }
      await populate();

      // 4) wire logout button using exported signOutUser if present
      const logoutBtn = document.getElementById('logout-btn');
      if (module && module.signOutUser) {
        logoutBtn.onclick = async () => {
          await module.signOutUser();
          window.location.href = 'login.html';
        };
      } else {
        // fallback: try to remove localStorage and redirect
        logoutBtn.onclick = () => {
          try { localStorage.removeItem('user'); } catch(e){}
          window.location.href = 'login.html';
        };
      }

      // 5) also refresh UI when localStorage changes (another tab)
      window.addEventListener('storage', () => populate());
    })();
  </script>
</body>
</html>