<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order History - Sarkar Telecom</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0f1115; color:#e7eaf0; margin:0; padding:0; text-align:center; }
    header { background:#171a21; padding:12px 20px; color:#06b6d4; font-size:18px; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
    h2 { margin:15px 0; color:#06b6d4; }
    .user-info { font-size:14px; color:#9aa3b2; }
    .auth-btn { background:#06b6d4; border:none; color:#001; padding:6px 10px; border-radius:6px; cursor:pointer; font-weight:bold; }
    .top-bar { display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:15px; flex-wrap:wrap; }
    .search-box input { padding:8px 12px; border-radius:6px; border:1px solid #333; background:#171a21; color:#e7eaf0; width:220px; }
    .btn { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:bold; }
    .btn-accent { background:#06b6d4; color:#001; }
    .btn-go { background:#22c55e; color:#001; }
    .btn-danger { background:#ef4444; color:#fff; }
    table { width:95%; margin:auto; border-collapse:collapse; background:#171a21; font-size:14px; }
    th, td { border:1px solid #333; padding:6px; text-align:center; }
    th { background:#06b6d4; color:#001; }
    .status-box { padding:4px 8px; border-radius:6px; color:#fff; font-size:13px; font-weight:bold; }
    .waiting { background:#eab308; color:#000; }
    .completed { background:#22c55e; }
    .cancelled { background:#ef4444; }
  </style>
</head>
<body>

<header>
  <span>üíé Sarkar Telecom - Order History</span>
  <div>
    <span id="userInfo" class="user-info">Not logged in</span>
    <button id="authBtn" class="auth-btn">Login</button>
  </div>
</header>

<h2>üìú Order History</h2>

<table>
  <thead>
    <tr>
      <th>SL</th>
      <th>Number</th>
      <th>Amount</th>
      <th>Status</th>
      <th>Time</th>
    </tr>
  </thead>
  <tbody id="orderTable"></tbody>
</table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ‚úÖ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBIIOv-2Laqugv5_HAIRNJllp8YUfYndF8",
    authDomain: "diamond-recharge-f7f59.firebaseapp.com",
    projectId: "diamond-recharge-f7f59",
    storageBucket: "diamond-recharge-f7f59.appspot.com",
    messagingSenderId: "657717928489",
    appId: "1:657717928489:web:70431ebc9afb7002d4b238",
    measurementId: "G-TDK78BQ8SQ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ‚úÖ CSV link
  const FINALDATA_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR4owbSc_h38ouaktOU30TYqH6wy93qYjmW0G5GWXhsBMzsrVSaWzPtVPA7YpyOUmlEpStByT8TxG0-/pub?gid=1098128992&single=true&output=csv";

  const orderTable = document.getElementById("orderTable");
  const authBtn = document.getElementById("authBtn");
  const userInfo = document.getElementById("userInfo");

  let currentUser = null;

  function parseCSV(text) {
    text = text.replace(/\r/g,'');
    return text.split("\n").filter(l=>l.trim()).map(line=>{
      const row = []; let cur="", inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='"'){ if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else inQ=!inQ; }
        else if(ch==="," && !inQ){ row.push(cur); cur=""; }
        else cur+=ch;
      }
      row.push(cur); return row;
    });
  }

  async function fetchCSV(url) {
    const res = await fetch(url, { cache: "no-store" });
    return parseCSV(await res.text());
  }

  // ‚úÖ ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡¶Æ‡ßü ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ (hh:mm AM/PM)
  function extractTimeOnly(ts) {
    if (!ts) return "-";
    const parts = ts.split(" ");
    if (parts.length >= 2) return parts[1] + " " + (parts[2] || "");
    return ts;
  }

  async function refundIfNeeded(user, orders) {
    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);
    if (!snap.exists()) return;
    const data = snap.data();
    let refundedOrders = data.refundedOrders || [];

    for (const row of orders) {
      const [time, number, amount, email, status] = row;
      if ((email||"").toLowerCase() !== user.email.toLowerCase()) continue;
      if (!(status||"").toLowerCase().includes("cancel")) continue;
      if (refundedOrders.includes(time)) continue;

      const refundAmount = Number(amount) || 0;
      if (refundAmount > 0) {
        await updateDoc(userRef, {
          balance: (data.balance || 0) + refundAmount,
          refundedOrders: arrayUnion(time)
        });
        console.log(`‚úÖ Refunded ${refundAmount} for order ${time}`);
      }
    }
  }

  async function loadOrdersFor(userEmail, userObj) {
    orderTable.innerHTML = "<tr><td colspan='5'>‚è≥ Loading...</td></tr>";
    try {
      const rows = await fetchCSV(FINALDATA_CSV);
      const allOrders = rows.slice(1).reverse().filter(r => (r[3]||"").toLowerCase() === userEmail.toLowerCase());
      orderTable.innerHTML = "";
      if (!allOrders.length) {
        orderTable.innerHTML = "<tr><td colspan='5'>No orders found.</td></tr>";
      } else {
        allOrders.forEach((row, idx) => {
          const [time, number, amount, email, status] = row;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${allOrders.length - idx}</td>
            <td>${number||"-"}</td>
            <td>${amount||"-"}</td>
            <td><span class="status-box">${status||"-"}</span></td>
            <td>${extractTimeOnly(time)}</td>
          `;
          orderTable.appendChild(tr);
        });
      }
      await refundIfNeeded(userObj, allOrders);
    } catch (e) {
      orderTable.innerHTML = `<tr><td colspan='5'>‚ùå Error: ${e.message}</td></tr>`;
    }
  }

  authBtn.onclick = async () => {
    if (currentUser) { await signOut(auth); }
    else { window.location.href = "login.html"; }
  };

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      userInfo.textContent = user.email;
      authBtn.textContent = "Logout";
      loadOrdersFor(user.email, user);
    } else {
      currentUser = null;
      userInfo.textContent = "Not logged in";
      authBtn.textContent = "Login";
      orderTable.innerHTML = "<tr><td colspan='5'>üîë Please log in to see your orders</td></tr>";
    }
  });
</script>
</body>
</html>